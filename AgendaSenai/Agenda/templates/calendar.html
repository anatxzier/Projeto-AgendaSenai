{% extends 'index.html' %}

{% block title %}
Calendário
{% endblock %}

{% block body %}
<div class="container">
    <div class="calendar">
        <div class="month">
            <i class="fas fa-angle-left prev"></i>
            <div class="date"></div>
            <i class="fas fa-angle-right next"></i>
        </div>
        <div class="weekdays">
            <div>Dom</div>
            <div>Seg</div>
            <div>Ter</div>
            <div>Qua</div>
            <div>Qui</div>
            <div>Sex</div>
            <div>Sáb</div>
        </div>
        <div class="days"></div>
        <div class="goto-today">

            <button id="schedule-btn" class="schedule-btn">Agendar</button>
            <button class="today-btn">Hoje</button>
        </div>
    </div>
    <div class="event-list">
        <div class="today-date">
            <div class="event-day"></div>
            <div class="event-date"></div>
        </div>
        <div class="events"></div>
        
    </div>
</div>

<form id="dateForm" action="{% url 'agendar' %}" method="post">
    {% csrf_token %}
    <input type="hidden" name="selected_date" id="selected_date">
</form>

<style>
    .container {
    width: 80%;
    margin: 50px auto;
    display: flex;
    justify-content: space-between;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.calendar {
    width: 70%;
    padding: 20px;
}

.month {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.date {
    font-size: 24px;
    font-weight: bold;
}

.weekdays, .days {
    display: flex;
    justify-content: space-between;
}

.weekdays div, .days div {
    width: 14.28%;
    text-align: center;
    padding: 10px 0;
}

.days {
    flex-wrap: wrap;
}

.day {
    cursor: pointer;
    border: 1px solid #f0f0f0;
    padding: 10px 0;
    transition: background-color 0.3s;
}

.day:hover {
    background-color: #f0f0f0;
}

.today {
    background-color: #ffc107;
    color: #fff;
}

.event {
    background-color: #28a745;
    color: #fff;
}

.goto-today {
    text-align: right;
    margin-top: 20px;
}

.today-btn {
    padding: 10px 20px;
    background-color: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.today-btn:hover {
    background-color: #0056b3;
}

.event-list {
    width: 30%;
    padding: 20px;
    border-left: 1px solid #f0f0f0;
}

.today-date {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.event-day {
    font-size: 24px;
    font-weight: bold;
}

.event-date {
    font-size: 20px;
    color: #777;
}

.events {
    max-height: 300px;
    overflow-y: auto;
}

.event {
    background-color: #007bff;
    color: #fff;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
}

.no-event {
    text-align: center;
    color: #777;
}
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const calendar = document.querySelector(".calendar"),
            date = document.querySelector(".date"),
            daysContainer = document.querySelector(".days"),
            prev = document.querySelector(".prev"),
            next = document.querySelector(".next"),
            todayBtn = document.querySelector(".today-btn"),
            eventDay = document.querySelector(".event-day"),
            eventDate = document.querySelector(".event-date"),
            eventsContainer = document.querySelector(".events"),
            scheduleBtn = document.getElementById("schedule-btn");
    
        let today = new Date();
        let activeDay = today.getDate();
        let month = today.getMonth();
        let year = today.getFullYear();
    
        const months = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
    
        const eventsArr = [];
        getEvents();
    
        function initCalendar() {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            const prevDays = prevLastDay.getDate();
            const lastDate = lastDay.getDate();
            const day = firstDay.getDay();
            const nextDays = 7 - lastDay.getDay() - 1;
    
            date.innerHTML = months[month] + " " + year;
    
            let days = "";
    
            for (let x = day; x > 0; x--) {
                days += `<div class="day prev-date">${prevDays - x + 1}</div>`;
            }
    
            for (let i = 1; i <= lastDate; i++) {
                let event = false;
                eventsArr.forEach((eventObj) => {
                    if (
                        eventObj.day === i &&
                        eventObj.month === month + 1 &&
                        eventObj.year === year
                    ) {
                        event = true;
                    }
                });
                if (
                    i === today.getDate() &&
                    year === today.getFullYear() &&
                    month === today.getMonth()
                ) {
                    activeDay = i;
                    getActiveDay(i);
                    updateEvents(i);
                    if (event) {
                        days += `<div class="day today active event">${i}</div>`;
                    } else {
                        days += `<div class="day today active">${i}</div>`;
                    }
                } else {
                    if (event) {
                        days += `<div class="day event">${i}</div>`;
                    } else {
                        days += `<div class="day">${i}</div>`;
                    }
                }
            }
    
            for (let j = 1; j <= nextDays; j++) {
                days += `<div class="day next-date">${j}</div>`;
            }
            daysContainer.innerHTML = days;
            addListener();
        }
    
        function prevMonth() {
            month--;
            if (month < 0) {
                month = 11;
                year--;
            }
            initCalendar();
        }
    
        function nextMonth() {
            month++;
            if (month > 11) {
                month = 0;
                year++;
            }
            initCalendar();
        }
    
        prev.addEventListener("click", prevMonth);
        next.addEventListener("click", nextMonth);
    
        todayBtn.addEventListener("click", () => {
            today = new Date();
            month = today.getMonth();
            year = today.getFullYear();
            initCalendar();
        });
    
        function addListener() {
            const days = document.querySelectorAll(".day");
            days.forEach((day) => {
                day.addEventListener("click", (e) => {
                    activeDay = Number(e.target.innerHTML);
                    getActiveDay(e.target.innerHTML);
                    updateEvents(Number(e.target.innerHTML));
                    days.forEach((day) => {
                        day.classList.remove("active");
                    });
                    if (e.target.classList.contains("prev-date")) {
                        prevMonth();
                        setTimeout(() => {
                            const days = document.querySelectorAll(".day");
                            days.forEach((day) => {
                                if (
                                    !day.classList.contains("prev-date") &&
                                    day.innerHTML === e.target.innerHTML
                                ) {
                                    day.classList.add("active");
                                }
                            });
                        }, 100);
                    } else if (e.target.classList.contains("next-date")) {
                        nextMonth();
                        setTimeout(() => {
                            const days = document.querySelectorAll(".day");
                            days.forEach((day) => {
                                if (
                                    !day.classList.contains("next-date") &&
                                    day.innerHTML === e.target.innerHTML
                                ) {
                                    day.classList.add("active");
                                }
                            });
                        }, 100);
                    } else {
                        e.target.classList.add("active");
                    }
                });
            });
        }
    
        function updateEvents(day) {
            let events = "";
            eventsArr.forEach((item) => {
                if (
                    item.day === day &&
                    item.month === month + 1 &&
                    item.year === year
                ) {
                    item.events.forEach((event) => {
                        events += `<div class="event">
                                        <div class="title">
                                            <i class="fas fa-circle"></i>
                                            <h3 class="event-title">${event.title}</h3>
                                        </div>
                                        <div class="event-time">
                                            <span class="event-time">${event.time}</span>
                                        </div>
                                    </div>`;
                    });
                }
            });
            if (events === "") {
                events = `<div class="no-event">
                                <h3>Sem eventos</h3>
                            </div>`;
            }
            eventsContainer.innerHTML = events;
            saveEvents();
        }
    
        function getActiveDay(date) {
            const day = new Date(year, month, date);
            const options = {
                weekday: "long",
            };
            const dayName = new Intl.DateTimeFormat("pt-BR", options).format(day);
            eventDay.innerHTML = dayName;
            eventDate.innerHTML = date + " " + months[month] + " " + year;
        }
    
        function saveEvents() {
            localStorage.setItem("events", JSON.stringify(eventsArr));
        }
    
        function getEvents() {
            if (localStorage.getItem("events") === null) {
                return;
            }
            eventsArr.push(...JSON.parse(localStorage.getItem("events")));
        }
    
        // Adicione um evento de clique no botão "Agendar"
        scheduleBtn.addEventListener("click", () => {
            const selectedDate = eventDate.innerHTML;
            document.getElementById("selected_date").value = selectedDate;
            document.getElementById("dateForm").submit();
        });
    
        initCalendar();
    });
    </script>
    {% endblock %}